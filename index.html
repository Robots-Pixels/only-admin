<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Admin - Contacts</title>
  <style>
    :root {
        --primary-color: #35424a;
        --accent-color: #e8491d;
        --success-color: #28a745;
        --info-color: #007bff;
        --text-light: #fff;
        --text-dark: #333;
        --bg-light: #f4f4f4;
        --border-color: #ddd;
    }

    * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
    }

    body {
        font-family: 'Arial', sans-serif;
        line-height: 1.6;
        background-color: var(--bg-light);
        color: var(--text-dark);
        font-size: 16px;
    }

    .container {
        width: 90%;
        max-width: 1200px;
        margin: 0 auto;
        padding: 15px;
    }

    header {
        background: var(--primary-color);
        color: var(--text-light);
        text-align: center;
        border-bottom: 3px solid var(--accent-color);
    }

    .header-image {
        width: 100%;
        max-width: 360px; 
        aspect-ratio: 3 / 1; 
        background-image: url("./assets/logo.jpeg");
        background-position: center;
        background-size: 60%;
        background-repeat: no-repeat;
        margin-left: 1%;
    }


    nav {
        background: var(--text-dark);
        padding: 0;
        text-align: center;
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
    }

    nav a {
        color: var(--text-light);
        text-decoration: none;
        padding: 15px;
        display: block;
        flex-grow: 1;
        transition: background-color 0.3s;
    }

    nav a:hover {
        background: var(--accent-color);
    }

    h2, h3 {
        margin: 10px 0;
        color: var(--primary-color);
    }

    .form-container {
        background: white;
        border-radius: 5px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        padding: 20px;
        margin-bottom: 20px;
    }

    .form-group {
        margin-bottom: 15px;
    }

    .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
    }

    .form-control {
        width: 100%;
        padding: 10px;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        font-size: 16px;
    }

    .form-control:focus {
        outline: none;
        border-color: var(--accent-color);
        box-shadow: 0 0 5px rgba(232, 73, 29, 0.3);
    }

    .btn {
        display: inline-block;
        background: var(--accent-color);
        color: var(--text-light);
        padding: 12px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
        width: 100%;
        transition: background-color 0.3s;
    }

    .btn:hover {
        background: var(--text-dark);
    }

    .list-container {
        display: flex;
        flex-direction: column;
        gap: 20px;
    }

    .list {
        background: white;
        border-radius: 5px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        padding: 15px;
    }

    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
    }

    table, th, td {
        border: 1px solid var(--border-color);
    }

    th, td {
        padding: 10px;
        text-align: left;
    }

    th {
        background-color: var(--primary-color);
        color: var(--text-light);
    }

    tr:nth-child(even) {
        background-color: #f2f2f2;
    }

    .action-btn {
        background: var(--success-color);
        color: var(--text-light);
        padding: 8px 12px;
        border: none;
        border-radius: 3px;
        cursor: pointer;
        margin-right: 5px;
        width: 100%;
        text-align: center;
    }

    .action-btn.add {
        background: var(--success-color);
    }

    .action-btn.save {
        background: var(--info-color);
    }

    .hidden {
        display: none;
    }

    /* Responsive Design */
    @media (min-width: 768px) {
        .btn {
            width: auto;
        }

        .list-container {
            flex-direction: row;
        }

        .list {
            flex: 1;
        }

        .action-btn {
            width: auto;
        }

        /* .header-image {
            margin-left: 0%;
            margin: 0px auto;
        } */
    }

    @media (max-width: 767px) {
        .container {
            width: 95%;
            padding: 10px;
        }

        nav {
            flex-direction: column;
        }

        nav a {
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        nav a:last-child {
            border-bottom: none;
        }

        .list-container {
            gap: 15px;
        }

        /* Responsive tables for mobile */
        table, thead, tbody, th, td, tr {
            display: block;
        }

        thead tr {
            position: absolute;
            top: -9999px;
            left: -9999px;
        }

        tr {
            margin-bottom: 15px;
            border: 1px solid var(--border-color);
        }

        td {
            border: none;
            position: relative;
            padding-left: 50%;
            text-align: right;
            border-bottom: 1px solid var(--border-color);
        }

        td:last-child {
            border-bottom: none;
        }

        td:before {
            position: absolute;
            top: 10px;
            left: 10px;
            width: 45%;
            padding-right: 10px;
            white-space: nowrap;
            font-weight: bold;
            text-align: left;
        }

        /* Labels for mobile view */
        #all-contacts tbody td:nth-of-type(1):before { content: "Nom:"; }
        #all-contacts tbody td:nth-of-type(2):before { content: "Prénom:"; }
        #all-contacts tbody td:nth-of-type(3):before { content: "Téléphone:"; }
        #all-contacts tbody td:nth-of-type(4):before { content: "Actions:"; }

        #selected-contacts tbody td:nth-of-type(1):before { content: "Nom:"; }
        #selected-contacts tbody td:nth-of-type(2):before { content: "Prénom:"; }
        #selected-contacts tbody td:nth-of-type(3):before { content: "Téléphone:"; }

        #repertoire-contacts tbody td:nth-of-type(1):before { content: "Nom:"; }
        #repertoire-contacts tbody td:nth-of-type(2):before { content: "Prénom:"; }
        #repertoire-contacts tbody td:nth-of-type(3):before { content: "Téléphone:"; }
        #repertoire-contacts tbody td:nth-of-type(4):before { content: "Actions:"; }
    }

    @media (max-width: 480px) {
        .form-container {
            padding: 15px 10px;
        }

        td {
            padding-left: 45%;
            font-size: 14px;
        }

        td:before {
            width: 40%;
            font-size: 14px;
        }

        .header-image {
            margin-left: 0%;
            margin: 0px auto;
        }

    }
</style>
</head>
<body>
  <header>
    <div class="header-image"></div>
  </header>
  <nav>
    <a href="#" id="nav-contacts">Liste des Contacts</a>
    <a href="#" id="nav-repertoire">Répertoire</a>
  </nav>

  <div class="container">
    <div id="contacts-page" class="hidden">
      <div class="form-container">
        <h2>Liste des Contacts</h2>
        <div class="list-container">
          <div class="list">
            <h3>Tous les Contacts</h3>
            <table id="all-contacts">
              <thead>
                <tr>
                  <th>Nom</th>
                  <th>Prénom</th>
                  <th>Téléphone</th>
                  <th>Profession</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
          <div class="list">
            <h3>Nouveaux Convertis</h3>
            <table id="selected-contacts">
              <thead>
                <tr>
                  <th>Nom</th>
                  <th>Prénom</th>
                  <th>Téléphone</th>
                  <th>Profession</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <div id="repertoire-page" class="hidden">
      <div class="form-container">
        <h2>Répertoire</h2>
        <table id="repertoire-contacts">
          <thead>
            <tr>
              <th>Nom</th>
              <th>Prénom</th>
              <th>Téléphone</th>
              <th>Profession</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    // Code JS corrige ici
    let contacts = [];
    let selectedContacts = [];

    const contactsPage = document.getElementById('contacts-page');
    const repertoirePage = document.getElementById('repertoire-page');
    const allContactsTable = document.querySelector('#all-contacts tbody');
    const selectedContactsTable = document.querySelector('#selected-contacts tbody');
    const repertoireContactsTable = document.querySelector('#repertoire-contacts tbody');

    function showPage(page) {
      contactsPage.classList.add('hidden');
      repertoirePage.classList.add('hidden');
      page.classList.remove('hidden');
    }

    document.getElementById('nav-contacts').addEventListener('click', (e) => {
      e.preventDefault();
      showPage(contactsPage);
      displayContacts();
    });

    document.getElementById('nav-repertoire').addEventListener('click', (e) => {
      e.preventDefault();
      showPage(repertoirePage);
      displayRepertoireContacts();
    });

    function saveContacts() {
      localStorage.setItem('contacts', JSON.stringify(contacts));
      localStorage.setItem('selectedContacts', JSON.stringify(selectedContacts));
    }

    function loadContacts() {
      const savedContacts = localStorage.getItem('contacts');
      const savedSelected = localStorage.getItem('selectedContacts');
      if (savedContacts) contacts = JSON.parse(savedContacts);
      if (savedSelected) selectedContacts = JSON.parse(savedSelected);
    }

    function fetchContacts() {
      fetch("https://church-backend-nzf2.onrender.com/api/contacts")
        .then(res => res.json())
        .then(data => {
          if (Array.isArray(data)) {
            contacts = data.map(c => ({
              nom: c.nom,
              prenom: c.prenom,
              adresse: c.adresse || "",
              profession: c.profession || "",
              telephone: c.telephone
            }));
            saveContacts();
          }
        })
        .catch(err => console.error("Erreur chargement contacts:", err));
    }

    function displayContacts() {
      allContactsTable.innerHTML = '';
      selectedContactsTable.innerHTML = '';
      contacts.forEach((c, i) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${c.nom}</td><td>${c.prenom}</td><td>${c.telephone}</td><td>${c.profession}</td>
          <td><button class="action-btn add" data-index="${i}">Ajouter</button></td>`;
        allContactsTable.appendChild(tr);
      });
      document.querySelectorAll('.action-btn.add').forEach(btn => {
        btn.addEventListener('click', () => addToSelected(btn.dataset.index));
      });
      selectedContacts.forEach(c => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${c.nom}</td><td>${c.prenom}</td><td>${c.telephone}</td><td>${c.profession}</td>`;
        selectedContactsTable.appendChild(tr);
      });
    }

    function addToSelected(i) {
      const c = contacts[i];
      if (!selectedContacts.some(x => x.nom === c.nom && x.prenom === c.prenom && x.telephone === c.telephone)) {
        selectedContacts.push(c);
        saveContacts();
        displayContacts();
      } else {
        alert("Ce contact est déjà ajouté.");
      }
    }

    function displayRepertoireContacts() {
      repertoireContactsTable.innerHTML = '';
      contacts.forEach((c, i) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${c.nom}</td><td>${c.prenom}</td><td>${c.telephone}</td><td>${c.profession}</td>
          <td><button class="action-btn save" data-index="${i}">Enregistrer Contact</button></td>`;
        repertoireContactsTable.appendChild(tr);
      });
      document.querySelectorAll('.action-btn.save').forEach(btn => {
        btn.addEventListener('click', () => saveToAddressBook(btn.dataset.index));
      });
    }

    function saveToAddressBook(i) {
      const c = contacts[i];
      const vCard = `BEGIN:VCARD\nVERSION:3.0\nFN:${c.prenom} ${c.nom}\nTEL:${c.telephone}\nADR:${c.adresse}\nEND:VCARD`;
      const blob = new Blob([vCard], { type: 'text/vcard' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${c.prenom}_${c.nom}.vcf`;
      a.click();
      URL.revokeObjectURL(url);
      alert("Contact enregistré dans le répertoire (via téléchargement)");
    }

    loadContacts();
    fetchContacts();
    showPage(contactsPage);
  </script>
</body>
</html>
